<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MEGA-115å¹´-9å‡10æ¨¡æ“¬æ¸¬é©—(114/11/9ä¹‹å¾Œé—œé–‰)</title>
    <style>
        :root {
            --bg: #f7f7fb;
            --panel: #ffffff;
            --text: #222;
            --muted: #6b7280;
            --brand: #2563eb;
            --danger: #dc2626;
            --ok: #16a34a;
            --warn: #b45309;
            --border: #e5e7eb;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
            color: var(--text)
        }

        header {
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, #fff 0%, #fff 80%, #ffffffcc 100%);
            border-bottom: 1px solid var(--border);
            z-index: 50
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 16px
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0,0,0,.06)
        }

        .p-16 {
            padding: 16px
        }

        .p-24 {
            padding: 24px
        }

        .flex {
            display: flex
        }

        .gap-12 {
            gap: 12px
        }

        .gap-16 {
            gap: 16px
        }

        .gap-24 {
            gap: 24px
        }

        .col {
            display: flex;
            flex-direction: column
        }

        .row {
            display: flex;
            align-items: center
        }

        .space-between {
            justify-content: space-between
        }

        .btn {
            appearance: none;
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer
        }

            .btn:hover {
                border-color: #cbd5e1
            }

            .btn.primary {
                background: var(--brand);
                border-color: var(--brand);
                color: #fff
            }

            .btn.ghost {
                background: transparent
            }

            .btn.danger {
                background: var(--danger);
                border-color: var(--danger);
                color: #fff
            }

            .btn.ok {
                background: var(--ok);
                border-color: var(--ok);
                color: #fff
            }

            .btn[disabled] {
                opacity: .5;
                cursor: not-allowed
            }

        .input, select {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 16px;
            background: #fff
        }

        label {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 6px
        }

        h1 {
            font-size: 22px;
            margin: 0
        }

        h2 {
            font-size: 18px;
            margin: 0 0 8px 0
        }

        .hint {
            font-size: 13px;
            color: var(--muted)
        }

        .pill {
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 13px;
            background: #fff
        }

        .q {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 14px;
            background: #fff
        }

        .q-title {
            font-weight: 700;
            margin-bottom: 10px
        }

        .q-meta {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px
        }

        .options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px
        }

        .option {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px
        }

        .badge {
            display: inline-block;
            background: #eef2ff;
            color: #3730a3;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 8px
        }

        .warn {
            color: var(--warn)
        }

        .error {
            color: var(--danger)
        }

        .good {
            color: var(--ok)
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 12px 0
        }

        details > summary {
            cursor: pointer;
            user-select: none
        }

        .sticky-footer {
            position: sticky;
            bottom: 0;
            background: #fff;
            border-top: 1px solid var(--border)
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px
        }

        @media (max-width:700px) {
            .grid-2 {
                grid-template-columns: 1fr
            }
        }

        code.inline {
            background: #f8fafc;
            border: 1px solid var(--border);
            padding: 1px 6px;
            border-radius: 6px
        }
    </style>
</head>
<body>
    <header>
        <div class="container row space-between">
            <div class="row gap-12">
                <h1>MEGA-115å¹´-9å‡10æ¨¡æ“¬æ¸¬é©—</h1>
                <span id="headerUser" class="pill" aria-live="polite"></span>
                <span id="headerSubject" class="pill" aria-live="polite"></span>
            </div>
            <div class="row gap-12">
                <button class="btn ghost" id="btnDownloadTemplate" style="display:none" title="ä¸‹è¼‰é¡Œåº« JSON ç¯„æœ¬">ä¸‹è¼‰é¡Œåº«ç¯„æœ¬</button>
                <button class="btn ghost" id="btnReset">é‡è¨­</button>
            </div>
        </div>
    </header>

    <main class="container" id="app">

        <!-- STEP 1. ä½¿ç”¨è€…åç¨± -->
        <section id="step1" class="card p-24" aria-labelledby="step1-title">
            <h2 id="step1-title">æ­¥é©Ÿä¸€ï¼šè¼¸å…¥ä½¿ç”¨è€…åç¨±</h2>
            <div class="grid-2" style="margin-top:12px">
                <div class="col">
                    <label for="username">å§“å / æš±ç¨±</label>
                    <input id="username" class="input" placeholder="è«‹è¼¸å…¥æ‚¨çš„åå­—" />
                    <p class="hint">æ­¤åç¨±å°‡é¡¯ç¤ºæ–¼é é¢ä¸Šæ–¹èˆ‡æˆç¸¾çµæœä¸­ã€‚</p>
                </div>
                <div class="col">
                    <label>å¿«é€Ÿé¸æ“‡ï¼ˆè¨˜ä½ä¸Šæ¬¡ï¼‰</label>
                    <div class="row gap-12">
                        <button class="btn" id="btnUseLastName">ä½¿ç”¨ä¸Šæ¬¡åç¨±</button>
                        <button class="btn" id="btnClearName">æ¸…é™¤ç´€éŒ„</button>
                    </div>
                </div>
            </div>
            <div class="divider"></div>
            <div class="row gap-12">
                <button class="btn primary" id="toStep2">ç¢ºå®šï¼Œé¸æ“‡æ¸¬é©—é …ç›®</button>
            </div>
        </section>

        <!-- STEP 2. é¸æ“‡æ¸¬é©—é …ç›®ï¼ˆå¾åŒç›®éŒ„ä¼ºæœå™¨è¼‰å…¥ JSON é¡Œåº«ï¼‰ -->
        <section id="step2" class="card p-24" style="display:none" aria-labelledby="step2-title">
            <h2 id="step2-title">æ­¥é©ŸäºŒï¼šé¸æ“‡æ¸¬é©—é …ç›®</h2>
            <!--<p class="hint">è«‹å°‡é¡Œåº« JSON æª”èˆ‡ <code class="inline">index.html</code> æ”¾åœ¨åŒä¸€è³‡æ–™å¤¾ï¼Œä¸¦æä¾›ä¸€ä»½ <code class="inline">quizzes.json</code> ã€Œæ¸…å–®æª”ã€ã€‚ä½¿ç”¨è€…é¸æ“‡å¾Œï¼Œç³»çµ±æœƒä»¥ <code class="inline">fetch()</code> è®€å…¥ç›¸å°æ‡‰æª”æ¡ˆã€‚</p>-->

            <div class="grid-2" style="margin-top:8px">
                <div class="col">
                    <!--  <label for="subjectList">æ¸¬é©—æ¸…å–®ï¼ˆä¾†è‡ª <code class="inline">quizzes.json</code>ï¼‰</label>-->
                    <select id="subjectList" class="input"></select>
                    <p class="hint" id="manifestHint"></p>
                </div>
                <div class="col">
                    <label>æ“ä½œ</label>
                    <div class="row gap-12">
                        <button class="btn" id="btnLoadServer">è¼‰å…¥æ­¤æ¸¬é©—</button>
                        <button class="btn" id="btnReloadManifest">é‡æ–°è®€å–æ¸…å–®</button>
                    </div>
                </div>
            </div>

            <details style="margin-top:16px">
                <summary>quizzes.json æ¸…å–®æ ¼å¼ï¼ˆç¯„ä¾‹ï¼‰</summary>
                <div class="p-16">
                    <pre style="white-space:pre-wrap;background:#f8fafc;border:1px solid var(--border);padding:12px;border-radius:12px"><code>{
      "quizzes": [
        { "title": "ä¸ƒä¸Š Unit 5 å–®å­—", "file": "unit5.json" },
        { "title": "ä¸ƒä¸Š L6 æ–‡æ³•è¤‡ç¿’", "file": "u6_grammar.json" }
      ]
    }</code></pre>
                    <ul>
                        <li><b>title</b>ï¼šé¡¯ç¤ºåç¨±ï¼ˆæœƒå‡ºç¾åœ¨é é¢æ¨™é ­èˆ‡æˆç¸¾ï¼‰ã€‚</li>
                        <li><b>file</b>ï¼šæª”åæˆ–ç›¸å°è·¯å¾‘ï¼ˆèˆ‡æœ¬é åŒè³‡æ–™å¤¾ï¼‰ã€‚</li>
                    </ul>
                </div>
            </details>

            <details style="margin-top:12px">
                <summary>é¡Œåº« JSON æ ¼å¼ï¼ˆäºŒé¸ä¸€ï¼Œèˆ‡å…ˆå‰ç›¸åŒï¼‰</summary>
                <div class="p-16">
                    <p class="hint">ï¼ˆAï¼‰åˆ†é–‹æ¬„ä½ï¼š<code class="inline">single</code> èˆ‡ <code class="inline">multi</code></p>
                    <pre style="white-space:pre-wrap;background:#f8fafc;border:1px solid var(--border);padding:12px;border-radius:12px"><code>{
      "subject": "ä¸ƒå¹´ç´š Unit 5",
      "single": [
        {"id":"S1","q":"Which is a fruit?","options":["Car","Apple","Chair","Desk"],"answer":1}
      ],
      "multi": [
        {"id":"M1","q":"Select colors.","options":["Red","Dog","Blue","Table"],"answer":[0,2]}
      ]
    }</code></pre>
                    <p class="hint">ï¼ˆBï¼‰åˆä½µé™£åˆ—ï¼š<code class="inline">questions</code>ï¼ˆæ¯é¡Œæ¨™ <code class="inline">type</code>ï¼‰</p>
                    <pre style="white-space:pre-wrap;background:#f8fafc;border:1px solid var(--border);padding:12px;border-radius:12px"><code>{
      "subject": "ä¸ƒå¹´ç´š Unit 5",
      "questions": [
        {"id":"S1","type":"single","q":"Which is a fruit?","options":["Car","Apple","Chair","Desk"],"answer":1},
        {"id":"M1","type":"multi","q":"Select colors.","options":["Red","Dog","Blue","Table"],"answer":[0,2]}
      ]
    }</code></pre>
                </div>
            </details>
        </section>

            <!-- STEP 3. ä½œç­”å€ -->
            <section id="step3" class="card p-24" style="display:none" aria-labelledby="step3-title">
                <div class="row space-between">
                    <h2 id="step3-title">æ­¥é©Ÿä¸‰ï¼šé–‹å§‹ä½œç­”</h2>
                    <div class="row gap-12">
                        <span class="pill">å–®é¸ï¼š<b>40</b> é¡Œ Ã— 1.5 åˆ†</span>
                        <span class="pill">è¤‡é¸ï¼š<b>16</b> é¡Œ Ã— 2.5 åˆ†</span>
                    </div>
                </div>
                <p class="hint" id="poolInfo"></p>
                <div id="quiz"></div>
            </section>

            <!-- æäº¤å€ -->
            <section id="submitBar" class="sticky-footer" style="display:none">
                <div class="container row space-between" style="padding:12px 16px">
                    <div class="row gap-12">
                        <span id="unansweredHint" class="warn"></span>
                    </div>
                    <div class="row gap-12">
                        <button class="btn" id="btnCheck">æª¢æŸ¥æœªä½œç­”</button>
                        <button class="btn ok" id="btnSubmit">é€å‡ºç­”æ¡ˆä¸¦è¨ˆåˆ†</button>
                    </div>
                </div>
            </section>

            <!-- çµæœå¡ -->
            <section id="result" class="card p-24" style="display:none" aria-live="polite">
                <h2>ä½œç­”çµæœ</h2>
                <p id="scoreText" style="font-size:20px;margin:8px 0"></p>
                <div class="row gap-12" id="resultBadges"></div>
                <div class="divider"></div>
                <div class="row gap-12">
                    <button class="btn" id="btnReview">æª¢è¦–è©³è§£</button>
                    <button class="btn" id="btnRetake">é‡æ–°æŠ½é¡Œå†æ¸¬ä¸€æ¬¡</button>
                    <button class="btn" id="btnExportCSV">åŒ¯å‡ºä½œç­”ç´€éŒ„ CSV</button>
                </div>
            </section>

</main>

    <script>
        // ======= å°å·¥å…· =======
        const qs = (s, el = document) => el.querySelector(s);
        const qsa = (s, el = document) => [...el.querySelectorAll(s)];
        const randPick = (arr, n) => { const copy = arr.slice(); for (let i = copy.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[copy[i], copy[j]] = [copy[j], copy[i]] } return copy.slice(0, Math.min(n, copy.length)); };
        const shuffleWithMapping = (arr) => { const map = arr.map((_, i) => i); for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[arr[i], arr[j]] = [arr[j], arr[i]];[map[i], map[j]] = [map[j], map[i]] } return { arr, map }; };
        const mapAnswerIndices = (answer, map) => { const reverse = new Map(map.map((oldIdx, newIdx) => [oldIdx, newIdx])); if (Array.isArray(answer)) return answer.map(idx => reverse.get(idx)).sort((a, b) => a - b); return reverse.get(answer); };
        const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
        const load = (k, _default = null) => { try { return JSON.parse(localStorage.getItem(k)) ?? _default; } catch { return _default } };
        const scrollToEl = (el) => el?.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // ======= å…¨åŸŸç‹€æ…‹ =======
        const REQUIRED_SINGLE = 40, REQUIRED_MULTI = 16, P_SINGLE = 1.5, P_MULTI = 2.5;
        let USER = { name: "", subject: "" };
        let pools = { single: [], multi: [] }; // åŸå§‹æ± 
        let quizQuestions = []; // å·²æŠ½å‡ºä¸¦å®Œæˆé¸é …æ´—ç‰Œçš„é¡Œç›®
        let answered = new Map(); // qid -> Set(indices)

        // é¡Œç›®ç‰©ä»¶çµ±ä¸€æ ¼å¼ï¼š{ id, type:"single"|"multi", q, options:[...], correct:[indices], points:number }

        // ======= ä¼ºæœå™¨è¼‰å…¥ï¼ˆåŒç›®éŒ„ï¼‰ =======
        async function loadManifest() {
            const hint = qs('#manifestHint');
            hint.textContent = 'æ­£åœ¨è®€å– quizzes.jsonâ€¦';
            try {
                const res = await fetch('./quizzes.json', { cache: 'no-store' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                const list = Array.isArray(data.quizzes) ? data.quizzes : [];
                const sel = qs('#subjectList');
                sel.innerHTML = '';
                if (list.length === 0) { sel.innerHTML = '<option value="">ï¼ˆæ¸…å–®ç‚ºç©ºï¼‰</option>'; hint.textContent = 'æ‰¾ä¸åˆ°ä»»ä½•æ¸¬é©—ï¼Œè«‹æª¢æŸ¥ quizzes.jsonã€‚'; return; }
                list.forEach((q, i) => {
                    const opt = document.createElement('option');
                    //opt.value = q.file; opt.textContent = q.title + '  â€”  ' + q.file; opt.dataset.title = q.title
                    opt.value = q.file; opt.textContent = q.title ; opt.dataset.title = q.title;
                    sel.appendChild(opt);
                });
                hint.textContent = `å…± ${list.length} ç­†æ¸¬é©—ã€‚`;
            } catch (err) {
                hint.innerHTML = `<span class="error">ç„¡æ³•è®€å– quizzes.jsonï¼š${err.message}</span>`;
            }
        }

        async function loadFromServer() {
            const sel = qs('#subjectList');
            const file = sel.value;
            const title = sel.options[sel.selectedIndex]?.dataset?.title || sel.options[sel.selectedIndex]?.textContent || '';
            if (!file) { alert('è«‹å…ˆå¾æ¸…å–®é¸æ“‡ä¸€å€‹æ¸¬é©—'); return; }
            try {
                const res = await fetch(`./${file}`, { cache: 'no-store' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();
                const { subject: subj, single, multi } = normalizeQuestions(json);
                USER.subject = subj || title || file;
                pools = { single, multi };
                afterPoolLoaded();
            } catch (err) {
                alert('è¼‰å…¥é¡Œåº«å¤±æ•—ï¼š' + err.message + 'è«‹ç¢ºèªæª”åèˆ‡è·¯å¾‘ï¼Œä¸¦ç¢ºä¿ JSON æ ¼å¼æ­£ç¢ºã€‚');
          }
        }

        function normalizeQuestions(json) {
            const subj = json.subject || '';
            let single = [], multi = [];
            if (Array.isArray(json.questions)) {
                json.questions.forEach(it => {
                    const base = { id: it.id || crypto.randomUUID(), q: it.q, options: it.options || [] };
                    if (it.type === 'multi') multi.push({ ...base, type: 'multi', correct: Array.isArray(it.answer) ? it.answer : [it.answer], points: P_MULTI });
                    else single.push({ ...base, type: 'single', correct: Array.isArray(it.answer) ? it.answer[0] : it.answer, points: P_SINGLE });
                });
            } else {
                if (Array.isArray(json.single)) {
                    single = json.single.map(it => ({ id: it.id || crypto.randomUUID(), type: 'single', q: it.q, options: it.options || [], correct: (Array.isArray(it.answer) ? it.answer[0] : it.answer), points: P_SINGLE }));
                }
                if (Array.isArray(json.multi)) {
                    multi = json.multi.map(it => ({ id: it.id || crypto.randomUUID(), type: 'multi', q: it.q, options: it.options || [], correct: (Array.isArray(it.answer) ? it.answer : [it.answer]), points: P_MULTI }));
                }
            }
            const ok1 = single.every(it => Number.isInteger(it.correct) && it.correct >= 0 && it.correct < it.options.length);
            const ok2 = multi.every(it => Array.isArray(it.correct) && it.correct.length > 0 && it.correct.every(c => Number.isInteger(c) && c >= 0 && c < it.options.length));
            if (!ok1 || !ok2) throw new Error('é¡Œåº«æ ¼å¼æœ‰èª¤ï¼šè«‹æª¢æŸ¥ answer èˆ‡ options å°æ‡‰æ˜¯å¦æ­£ç¢ºã€‚');
            return { subject: subj, single, multi };
        }

        function buildQuiz() {
            const sPicked = randPick(pools.single, REQUIRED_SINGLE);
            const mPicked = randPick(pools.multi, REQUIRED_MULTI);
            const warn = [];
            if (pools.single.length < REQUIRED_SINGLE) warn.push(`å–®é¸é¡Œæ•¸ä¸è¶³ï¼Œåƒ…æœ‰ ${pools.single.length} é¡Œï¼ˆéœ€ ${REQUIRED_SINGLE} é¡Œï¼‰ã€‚`);
            if (pools.multi.length < REQUIRED_MULTI) warn.push(`è¤‡é¸é¡Œæ•¸ä¸è¶³ï¼Œåƒ…æœ‰ ${pools.multi.length} é¡Œï¼ˆéœ€ ${REQUIRED_MULTI} é¡Œï¼‰ã€‚`);
            if (warn.length) qs('#poolInfo').innerHTML = `<span class="warn">${warn.join(' ')}</span>`; else qs('#poolInfo').textContent = '';

            quizQuestions = [];
            let seq = 1;
            const holder = qs('#quiz');
            holder.innerHTML = '';
            answered = new Map();

            const renderOne = (it) => {
                let newOptions = it.options.slice();
                let map = newOptions.map((_, i) => i);
                // å–®é¸é¡Œä¸æ´—ç‰Œï¼Œè¤‡é¸é¡Œæ‰æ´—ç‰Œ
                if (it.type === 'multi') {
                    ({ arr: newOptions, map } = shuffleWithMapping(it.options.slice()));
                }
                const newCorrect = Array.isArray(it.correct) ? mapAnswerIndices(it.correct, map) : mapAnswerIndices([it.correct], map)[0];
                const qid = it.id;
                const q = { id: qid, type: it.type, q: it.q, options: newOptions, correct: Array.isArray(newCorrect) ? newCorrect : [newCorrect], points: it.points };
                quizQuestions.push(q);

                const wrap = document.createElement('div');
                wrap.className = 'q';
                wrap.dataset.qid = qid;
                wrap.innerHTML = `
              <div class="q-title">${seq}. ${escapeHtml(q.q)} ${q.type === 'multi' ? '<span class="badge">è¤‡é¸</span>' : ''}</div>
              <div class="q-meta">é…åˆ†ï¼š${q.points} åˆ†</div>
              <div class="options"></div>
            `;
                const opts = qs('.options', wrap);
                q.options.forEach((opt, optIdx) => {
                    const id = `${qid}_${optIdx}`;
                    const label = document.createElement('label');
                    label.className = 'option row gap-12';
                    label.setAttribute('for', id);
                    label.innerHTML = `
                <input id="${id}" name="${qid}" type="${q.type === 'single' ? 'radio' : 'checkbox'}" value="${optIdx}" />
                <span>${escapeHtml(opt)}</span>
              `;
                    opts.appendChild(label);
                });
                holder.appendChild(wrap);
                seq++;
            };

            sPicked.forEach(renderOne);
            mPicked.forEach(renderOne);
        }

        function escapeHtml(str) {
            return (str || '').toString().replace(/[&<>\"]/g, s => ({
                "&": "&amp;", "<": "&lt;",
                ">": "&gt;", "\"": "&quot;"
            }[s]));
        }

        function gatherAnswers() {
            const unanswered = [];
            answered = new Map();
            for (const q of quizQuestions) {
                const nodes = qsa(`[name="${q.id}"]`);
                const selected = nodes.filter(n => n.checked).map(n => parseInt(n.value, 10));
                if (q.type === 'single') {
                    if (selected.length !== 1) unanswered.push(q);
                    else answered.set(q.id, new Set(selected));
                } else {
                    if (selected.length < 1) unanswered.push(q);
                    else answered.set(q.id, new Set(selected));
                }
            }
            return unanswered;
        }

        function scoreNow() {
            let total = 0, got = 0, singleCount = 0, multiCount = 0, singleGot = 0, multiGot = 0;
            for (const q of quizQuestions) {
                total += q.points;
                const ans = answered.get(q.id) || new Set();
                const correctSet = new Set(q.correct);
                const isCorrect = ans.size === correctSet.size && [...ans].every(x => correctSet.has(x));
                if (isCorrect) {
                    got += q.points;
                    if (q.type === 'single') { singleGot++; } else { multiGot++; }
                }
                if (q.type === 'single') singleCount++; else multiCount++;
            }
            const percent = total > 0 ? Math.round((got / total) * 10000) / 100 : 0;
            return { got, total, percent, singleCount, singleGot, multiCount, multiGot };
        }

        function showResult() {
            const r = scoreNow();
            const t = `ğŸ‘¤ ${USER.name}ï½œğŸ“˜ ${USER.subject}ï½œåˆ†æ•¸ï¼š${r.got.toFixed(2)} / ${r.total.toFixed(2)}ï¼ˆ${r.percent}%ï¼‰`;
            qs('#scoreText').textContent = t;
            const badges = qs('#resultBadges');
            badges.innerHTML = '';
            const mk = (txt, cls = 'pill') => { const s = document.createElement('span'); s.className = cls; s.textContent = txt; return s; };
            badges.append(
                mk(`å–®é¸ç­”å° ${r.singleGot} / ${r.singleCount}`),
                mk(`è¤‡é¸ç­”å° ${r.multiGot} / ${r.multiCount}`)
            );
            qs('#result').style.display = 'block';
            window.scrollTo({ top: qs('#result').offsetTop - 20, behavior: 'smooth' });
        }

        function exportCSV() {
            const rows = [['name', 'subject', 'qid', 'type', 'correct', 'your_answer', 'points', 'earned']];
            for (const q of quizQuestions) {
                const ans = answered.get(q.id) || new Set();
                const correctSet = new Set(q.correct);
                const isCorrect = ans.size === correctSet.size && [...ans].every(x => correctSet.has(x));
                rows.push([
                    USER.name,
                    USER.subject,
                    q.id,
                    q.type,
                    JSON.stringify(q.correct),
                    JSON.stringify([...ans].sort((a, b) => a - b)),
                    q.points,
                    isCorrect ? q.points : 0
                ]);
            }
            const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g, '""')}"`).join(',')).join('');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${USER.subject || 'quiz'}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }

        // ======= äº‹ä»¶ç¶å®š =======
        qs('#btnUseLastName').onclick = () => { const v = load('quiz:name', ''); if (v) { qs('#username').value = v } else { alert('å°šç„¡ç´€éŒ„'); } };
        qs('#btnClearName').onclick = () => { localStorage.removeItem('quiz:name'); alert('å·²æ¸…é™¤åç¨±ç´€éŒ„'); };

        qs('#toStep2').onclick = async () => {
            const name = qs('#username').value.trim();
            if (!name) { alert('è«‹å…ˆè¼¸å…¥åç¨±'); return; }
            USER.name = name; save('quiz:name', name);
            qs('#headerUser').textContent = `ğŸ‘¤ ${USER.name}`;
            qs('#step1').style.display = 'none';
            qs('#step2').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            await loadManifest();
        };

        qs('#btnLoadServer').onclick = loadFromServer;
        qs('#btnReloadManifest').onclick = loadManifest;

        function afterPoolLoaded() {
            qs('#headerSubject').textContent = `ğŸ“˜ ${USER.subject}`;
            qs('#step2').style.display = 'none';
            qs('#step3').style.display = 'block';
            qs('#submitBar').style.display = 'block';
            buildQuiz();
            qs('#result').style.display = 'none';
            window.scrollTo({ top: qs('#step3').offsetTop - 20, behavior: 'smooth' });
        }

        qs('#btnCheck').onclick = () => {
            const missing = gatherAnswers();
            if (missing.length === 0) {
                qs('#unansweredHint').textContent = 'å·²å®Œæˆæ‰€æœ‰é¡Œç›®ï¼Œå¯ä»¥é€å‡ºï¼';
                qs('#unansweredHint').className = 'good';
            } else {
                qs('#unansweredHint').textContent = `å°šæœ‰ ${missing.length} é¡Œæœªä½œç­”ï¼ˆä¾‹å¦‚ç¬¬ ${findQuestionNumber(missing[0].id)} é¡Œï¼‰`;
                qs('#unansweredHint').className = 'warn';
                scrollToEl(qs(`[data-qid="${missing[0].id}"]`));
            }
        };

        function findQuestionNumber(qid) {
            const idx = quizQuestions.findIndex(q => q.id === qid);
            return idx >= 0 ? idx + 1 : '?';
        }

        qs('#btnSubmit').onclick = () => {
            const missing = gatherAnswers();
            if (missing.length > 0) {
                alert(`é‚„æœ‰ ${missing.length} é¡Œæœªä½œç­”ã€‚è«‹å®Œæˆå¾Œå†é€å‡ºã€‚
ï¼ˆç¬¬ä¸€å€‹æœªä½œç­”ï¼šç¬¬ ${findQuestionNumber(missing[0].id)} é¡Œï¼‰`);
                scrollToEl(qs(`[data-qid="${missing[0].id}"]`));
                return;
            }
            showResult();
        };

        qs('#btnReview').onclick = () => {
            for (const q of quizQuestions) {
                const wrap = qs(`[data-qid="${q.id}"]`);
                const nodes = qsa(`[name="${q.id}"]`, wrap);
                const ans = answered.get(q.id) || new Set();
                nodes.forEach((n, i) => {
                    const label = n.closest('label');
                    label.style.borderColor = '#e5e7eb'; label.style.background = '#fff';
                    if (q.correct.includes(i)) {
                        label.style.borderColor = '#a7f3d0'; label.style.background = '#ecfdf5';
                    }
                    if (n.checked && !q.correct.includes(i)) {
                        label.style.borderColor = '#fecaca'; label.style.background = '#fef2f2';
                    }
                    n.disabled = true;
                });
            }
            alert('å·²ä»¥ç¶ è‰²æ¨™ç¤ºæ­£ç¢ºé¸é …ã€ç´…è‰²æ¨™ç¤ºæ‚¨å‹¾é¸çš„éŒ¯èª¤é¸é …ã€‚');
        };

        qs('#btnRetake').onclick = () => { buildQuiz(); qs('#result').style.display = 'none'; qs('#unansweredHint').textContent = ''; window.scrollTo({ top: qs('#step3').offsetTop - 20, behavior: 'smooth' }); };
        qs('#btnExportCSV').onclick = exportCSV;

        qs('#btnReset').onclick = () => { location.reload(); };

        qs('#btnDownloadTemplate').onclick = () => {
            const tmpl = JSON.stringify(getTemplate(), null, 2);
            const blob = new Blob([tmpl], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'quiz_template.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        };

        function getTemplate() {
            return { subject: "è«‹å¡«å…¥æ¸¬é©—é …ç›®åç¨±", questions: [{ id: "S1", type: "single", q: "Which is a fruit?", options: ["Car", "Apple", "Chair", "Desk"], answer: 1 }, { id: "M1", type: "multi", q: "Select colors.", options: ["Red", "Dog", "Blue", "Table"], answer: [0, 2] }] };
        }

        (function init() { const last = load('quiz:name', ''); if (last) { qs('#username').value = last; } })();
    </script>
</body>
</html>
