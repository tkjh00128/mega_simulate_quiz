<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MEGA-115年-9升10模擬測驗(114/11/9之後關閉)</title>
    <style>
        :root {
            --bg: #f7f7fb;
            --panel: #ffffff;
            --text: #222;
            --muted: #6b7280;
            --brand: #2563eb;
            --danger: #dc2626;
            --ok: #16a34a;
            --warn: #b45309;
            --border: #e5e7eb;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
            color: var(--text)
        }

        header {
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, #fff 0%, #fff 80%, #ffffffcc 100%);
            border-bottom: 1px solid var(--border);
            z-index: 50
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 16px
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0,0,0,.06)
        }

        .p-16 {
            padding: 16px
        }

        .p-24 {
            padding: 24px
        }

        .flex {
            display: flex
        }

        .gap-12 {
            gap: 12px
        }

        .gap-16 {
            gap: 16px
        }

        .gap-24 {
            gap: 24px
        }

        .col {
            display: flex;
            flex-direction: column
        }

        .row {
            display: flex;
            align-items: center
        }

        .space-between {
            justify-content: space-between
        }

        .btn {
            appearance: none;
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer
        }

            .btn:hover {
                border-color: #cbd5e1
            }

            .btn.primary {
                background: var(--brand);
                border-color: var(--brand);
                color: #fff
            }

            .btn.ghost {
                background: transparent
            }

            .btn.danger {
                background: var(--danger);
                border-color: var(--danger);
                color: #fff
            }

            .btn.ok {
                background: var(--ok);
                border-color: var(--ok);
                color: #fff
            }

            .btn[disabled] {
                opacity: .5;
                cursor: not-allowed
            }

        .input, select {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 16px;
            background: #fff
        }

        label {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 6px
        }

        h1 {
            font-size: 22px;
            margin: 0
        }

        h2 {
            font-size: 18px;
            margin: 0 0 8px 0
        }

        .hint {
            font-size: 13px;
            color: var(--muted)
        }

        .pill {
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 13px;
            background: #fff
        }

        .q {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 14px;
            background: #fff
        }

        .q-title {
            font-weight: 700;
            margin-bottom: 10px
        }

        .q-meta {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px
        }

        .options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px
        }

        .option {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px
        }

        .badge {
            display: inline-block;
            background: #eef2ff;
            color: #3730a3;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 8px
        }

        .warn {
            color: var(--warn)
        }

        .error {
            color: var(--danger)
        }

        .good {
            color: var(--ok)
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 12px 0
        }

        details > summary {
            cursor: pointer;
            user-select: none
        }

        .sticky-footer {
            position: sticky;
            bottom: 0;
            background: #fff;
            border-top: 1px solid var(--border)
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px
        }

        @media (max-width:700px) {
            .grid-2 {
                grid-template-columns: 1fr
            }
        }

        code.inline {
            background: #f8fafc;
            border: 1px solid var(--border);
            padding: 1px 6px;
            border-radius: 6px
        }
    </style>
</head>
<body>
    <header>
        <div class="container row space-between">
            <div class="row gap-12">
                <h1>MEGA-115年-9升10模擬測驗</h1>
                <span id="headerUser" class="pill" aria-live="polite"></span>
                <span id="headerSubject" class="pill" aria-live="polite"></span>
            </div>
            <div class="row gap-12">
                <button class="btn ghost" id="btnDownloadTemplate" style="display:none" title="下載題庫 JSON 範本">下載題庫範本</button>
                <button class="btn ghost" id="btnReset">重設</button>
            </div>
        </div>
    </header>

    <main class="container" id="app">

        <!-- STEP 1. 使用者名稱 -->
        <section id="step1" class="card p-24" aria-labelledby="step1-title">
            <h2 id="step1-title">步驟一：輸入使用者名稱</h2>
            <div class="grid-2" style="margin-top:12px">
                <div class="col">
                    <label for="username">姓名 / 暱稱</label>
                    <input id="username" class="input" placeholder="請輸入您的名字" />
                    <p class="hint">此名稱將顯示於頁面上方與成績結果中。</p>
                </div>
                <div class="col">
                    <label>快速選擇（記住上次）</label>
                    <div class="row gap-12">
                        <button class="btn" id="btnUseLastName">使用上次名稱</button>
                        <button class="btn" id="btnClearName">清除紀錄</button>
                    </div>
                </div>
            </div>
            <div class="divider"></div>
            <div class="row gap-12">
                <button class="btn primary" id="toStep2">確定，選擇測驗項目</button>
            </div>
        </section>

        <!-- STEP 2. 選擇測驗項目（從同目錄伺服器載入 JSON 題庫） -->
        <section id="step2" class="card p-24" style="display:none" aria-labelledby="step2-title">
            <h2 id="step2-title">步驟二：選擇測驗項目</h2>
            <!--<p class="hint">請將題庫 JSON 檔與 <code class="inline">index.html</code> 放在同一資料夾，並提供一份 <code class="inline">quizzes.json</code> 「清單檔」。使用者選擇後，系統會以 <code class="inline">fetch()</code> 讀入相對應檔案。</p>-->

            <div class="grid-2" style="margin-top:8px">
                <div class="col">
                    <!--  <label for="subjectList">測驗清單（來自 <code class="inline">quizzes.json</code>）</label>-->
                    <select id="subjectList" class="input"></select>
                    <p class="hint" id="manifestHint"></p>
                </div>
                <div class="col">
                    <label>操作</label>
                    <div class="row gap-12">
                        <button class="btn" id="btnLoadServer">載入此測驗</button>
                        <button class="btn" id="btnReloadManifest">重新讀取清單</button>
                    </div>
                </div>
            </div>

            <details style="margin-top:16px">
                <summary>quizzes.json 清單格式（範例）</summary>
                <div class="p-16">
                    <pre style="white-space:pre-wrap;background:#f8fafc;border:1px solid var(--border);padding:12px;border-radius:12px"><code>{
      "quizzes": [
        { "title": "七上 Unit 5 單字", "file": "unit5.json" },
        { "title": "七上 L6 文法複習", "file": "u6_grammar.json" }
      ]
    }</code></pre>
                    <ul>
                        <li><b>title</b>：顯示名稱（會出現在頁面標頭與成績）。</li>
                        <li><b>file</b>：檔名或相對路徑（與本頁同資料夾）。</li>
                    </ul>
                </div>
            </details>

            <details style="margin-top:12px">
                <summary>題庫 JSON 格式（二選一，與先前相同）</summary>
                <div class="p-16">
                    <p class="hint">（A）分開欄位：<code class="inline">single</code> 與 <code class="inline">multi</code></p>
                    <pre style="white-space:pre-wrap;background:#f8fafc;border:1px solid var(--border);padding:12px;border-radius:12px"><code>{
      "subject": "七年級 Unit 5",
      "single": [
        {"id":"S1","q":"Which is a fruit?","options":["Car","Apple","Chair","Desk"],"answer":1}
      ],
      "multi": [
        {"id":"M1","q":"Select colors.","options":["Red","Dog","Blue","Table"],"answer":[0,2]}
      ]
    }</code></pre>
                    <p class="hint">（B）合併陣列：<code class="inline">questions</code>（每題標 <code class="inline">type</code>）</p>
                    <pre style="white-space:pre-wrap;background:#f8fafc;border:1px solid var(--border);padding:12px;border-radius:12px"><code>{
      "subject": "七年級 Unit 5",
      "questions": [
        {"id":"S1","type":"single","q":"Which is a fruit?","options":["Car","Apple","Chair","Desk"],"answer":1},
        {"id":"M1","type":"multi","q":"Select colors.","options":["Red","Dog","Blue","Table"],"answer":[0,2]}
      ]
    }</code></pre>
                </div>
            </details>
        </section>

            <!-- STEP 3. 作答區 -->
            <section id="step3" class="card p-24" style="display:none" aria-labelledby="step3-title">
                <div class="row space-between">
                    <h2 id="step3-title">步驟三：開始作答</h2>
                    <div class="row gap-12">
                        <span class="pill">單選：<b>40</b> 題 × 1.5 分</span>
                        <span class="pill">複選：<b>16</b> 題 × 2.5 分</span>
                    </div>
                </div>
                <p class="hint" id="poolInfo"></p>
                <div id="quiz"></div>
            </section>

            <!-- 提交區 -->
            <section id="submitBar" class="sticky-footer" style="display:none">
                <div class="container row space-between" style="padding:12px 16px">
                    <div class="row gap-12">
                        <span id="unansweredHint" class="warn"></span>
                    </div>
                    <div class="row gap-12">
                        <button class="btn" id="btnCheck">檢查未作答</button>
                        <button class="btn ok" id="btnSubmit">送出答案並計分</button>
                    </div>
                </div>
            </section>

            <!-- 結果卡 -->
            <section id="result" class="card p-24" style="display:none" aria-live="polite">
                <h2>作答結果</h2>
                <p id="scoreText" style="font-size:20px;margin:8px 0"></p>
                <div class="row gap-12" id="resultBadges"></div>
                <div class="divider"></div>
                <div class="row gap-12">
                    <button class="btn" id="btnReview">檢視詳解</button>
                    <button class="btn" id="btnRetake">重新抽題再測一次</button>
                    <button class="btn" id="btnExportCSV">匯出作答紀錄 CSV</button>
                </div>
            </section>

</main>

    <script>
        // ======= 小工具 =======
        const qs = (s, el = document) => el.querySelector(s);
        const qsa = (s, el = document) => [...el.querySelectorAll(s)];
        const randPick = (arr, n) => { const copy = arr.slice(); for (let i = copy.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[copy[i], copy[j]] = [copy[j], copy[i]] } return copy.slice(0, Math.min(n, copy.length)); };
        const shuffleWithMapping = (arr) => { const map = arr.map((_, i) => i); for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[arr[i], arr[j]] = [arr[j], arr[i]];[map[i], map[j]] = [map[j], map[i]] } return { arr, map }; };
        const mapAnswerIndices = (answer, map) => { const reverse = new Map(map.map((oldIdx, newIdx) => [oldIdx, newIdx])); if (Array.isArray(answer)) return answer.map(idx => reverse.get(idx)).sort((a, b) => a - b); return reverse.get(answer); };
        const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
        const load = (k, _default = null) => { try { return JSON.parse(localStorage.getItem(k)) ?? _default; } catch { return _default } };
        const scrollToEl = (el) => el?.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // ======= 全域狀態 =======
        const REQUIRED_SINGLE = 40, REQUIRED_MULTI = 16, P_SINGLE = 1.5, P_MULTI = 2.5;
        let USER = { name: "", subject: "" };
        let pools = { single: [], multi: [] }; // 原始池
        let quizQuestions = []; // 已抽出並完成選項洗牌的題目
        let answered = new Map(); // qid -> Set(indices)

        // 題目物件統一格式：{ id, type:"single"|"multi", q, options:[...], correct:[indices], points:number }

        // ======= 伺服器載入（同目錄） =======
        async function loadManifest() {
            const hint = qs('#manifestHint');
            hint.textContent = '正在讀取 quizzes.json…';
            try {
                const res = await fetch('./quizzes.json', { cache: 'no-store' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                const list = Array.isArray(data.quizzes) ? data.quizzes : [];
                const sel = qs('#subjectList');
                sel.innerHTML = '';
                if (list.length === 0) { sel.innerHTML = '<option value="">（清單為空）</option>'; hint.textContent = '找不到任何測驗，請檢查 quizzes.json。'; return; }
                list.forEach((q, i) => {
                    const opt = document.createElement('option');
                    //opt.value = q.file; opt.textContent = q.title + '  —  ' + q.file; opt.dataset.title = q.title
                    opt.value = q.file; opt.textContent = q.title ; opt.dataset.title = q.title;
                    sel.appendChild(opt);
                });
                hint.textContent = `共 ${list.length} 筆測驗。`;
            } catch (err) {
                hint.innerHTML = `<span class="error">無法讀取 quizzes.json：${err.message}</span>`;
            }
        }

        async function loadFromServer() {
            const sel = qs('#subjectList');
            const file = sel.value;
            const title = sel.options[sel.selectedIndex]?.dataset?.title || sel.options[sel.selectedIndex]?.textContent || '';
            if (!file) { alert('請先從清單選擇一個測驗'); return; }
            try {
                const res = await fetch(`./${file}`, { cache: 'no-store' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();
                const { subject: subj, single, multi } = normalizeQuestions(json);
                USER.subject = subj || title || file;
                pools = { single, multi };
                afterPoolLoaded();
            } catch (err) {
                alert('載入題庫失敗：' + err.message + '請確認檔名與路徑，並確保 JSON 格式正確。');
          }
        }

        function normalizeQuestions(json) {
            const subj = json.subject || '';
            let single = [], multi = [];
            if (Array.isArray(json.questions)) {
                json.questions.forEach(it => {
                    const base = { id: it.id || crypto.randomUUID(), q: it.q, options: it.options || [] };
                    if (it.type === 'multi') multi.push({ ...base, type: 'multi', correct: Array.isArray(it.answer) ? it.answer : [it.answer], points: P_MULTI });
                    else single.push({ ...base, type: 'single', correct: Array.isArray(it.answer) ? it.answer[0] : it.answer, points: P_SINGLE });
                });
            } else {
                if (Array.isArray(json.single)) {
                    single = json.single.map(it => ({ id: it.id || crypto.randomUUID(), type: 'single', q: it.q, options: it.options || [], correct: (Array.isArray(it.answer) ? it.answer[0] : it.answer), points: P_SINGLE }));
                }
                if (Array.isArray(json.multi)) {
                    multi = json.multi.map(it => ({ id: it.id || crypto.randomUUID(), type: 'multi', q: it.q, options: it.options || [], correct: (Array.isArray(it.answer) ? it.answer : [it.answer]), points: P_MULTI }));
                }
            }
            const ok1 = single.every(it => Number.isInteger(it.correct) && it.correct >= 0 && it.correct < it.options.length);
            const ok2 = multi.every(it => Array.isArray(it.correct) && it.correct.length > 0 && it.correct.every(c => Number.isInteger(c) && c >= 0 && c < it.options.length));
            if (!ok1 || !ok2) throw new Error('題庫格式有誤：請檢查 answer 與 options 對應是否正確。');
            return { subject: subj, single, multi };
        }

        function buildQuiz() {
            const sPicked = randPick(pools.single, REQUIRED_SINGLE);
            const mPicked = randPick(pools.multi, REQUIRED_MULTI);
            const warn = [];
            if (pools.single.length < REQUIRED_SINGLE) warn.push(`單選題數不足，僅有 ${pools.single.length} 題（需 ${REQUIRED_SINGLE} 題）。`);
            if (pools.multi.length < REQUIRED_MULTI) warn.push(`複選題數不足，僅有 ${pools.multi.length} 題（需 ${REQUIRED_MULTI} 題）。`);
            if (warn.length) qs('#poolInfo').innerHTML = `<span class="warn">${warn.join(' ')}</span>`; else qs('#poolInfo').textContent = '';

            quizQuestions = [];
            let seq = 1;
            const holder = qs('#quiz');
            holder.innerHTML = '';
            answered = new Map();

            const renderOne = (it) => {
                let newOptions = it.options.slice();
                let map = newOptions.map((_, i) => i);
                // 單選題不洗牌，複選題才洗牌
                if (it.type === 'multi') {
                    ({ arr: newOptions, map } = shuffleWithMapping(it.options.slice()));
                }
                const newCorrect = Array.isArray(it.correct) ? mapAnswerIndices(it.correct, map) : mapAnswerIndices([it.correct], map)[0];
                const qid = it.id;
                const q = { id: qid, type: it.type, q: it.q, options: newOptions, correct: Array.isArray(newCorrect) ? newCorrect : [newCorrect], points: it.points };
                quizQuestions.push(q);

                const wrap = document.createElement('div');
                wrap.className = 'q';
                wrap.dataset.qid = qid;
                wrap.innerHTML = `
              <div class="q-title">${seq}. ${escapeHtml(q.q)} ${q.type === 'multi' ? '<span class="badge">複選</span>' : ''}</div>
              <div class="q-meta">配分：${q.points} 分</div>
              <div class="options"></div>
            `;
                const opts = qs('.options', wrap);
                q.options.forEach((opt, optIdx) => {
                    const id = `${qid}_${optIdx}`;
                    const label = document.createElement('label');
                    label.className = 'option row gap-12';
                    label.setAttribute('for', id);
                    label.innerHTML = `
                <input id="${id}" name="${qid}" type="${q.type === 'single' ? 'radio' : 'checkbox'}" value="${optIdx}" />
                <span>${escapeHtml(opt)}</span>
              `;
                    opts.appendChild(label);
                });
                holder.appendChild(wrap);
                seq++;
            };

            sPicked.forEach(renderOne);
            mPicked.forEach(renderOne);
        }

        function escapeHtml(str) {
            return (str || '').toString().replace(/[&<>\"]/g, s => ({
                "&": "&amp;", "<": "&lt;",
                ">": "&gt;", "\"": "&quot;"
            }[s]));
        }

        function gatherAnswers() {
            const unanswered = [];
            answered = new Map();
            for (const q of quizQuestions) {
                const nodes = qsa(`[name="${q.id}"]`);
                const selected = nodes.filter(n => n.checked).map(n => parseInt(n.value, 10));
                if (q.type === 'single') {
                    if (selected.length !== 1) unanswered.push(q);
                    else answered.set(q.id, new Set(selected));
                } else {
                    if (selected.length < 1) unanswered.push(q);
                    else answered.set(q.id, new Set(selected));
                }
            }
            return unanswered;
        }

        function scoreNow() {
            let total = 0, got = 0, singleCount = 0, multiCount = 0, singleGot = 0, multiGot = 0;
            for (const q of quizQuestions) {
                total += q.points;
                const ans = answered.get(q.id) || new Set();
                const correctSet = new Set(q.correct);
                const isCorrect = ans.size === correctSet.size && [...ans].every(x => correctSet.has(x));
                if (isCorrect) {
                    got += q.points;
                    if (q.type === 'single') { singleGot++; } else { multiGot++; }
                }
                if (q.type === 'single') singleCount++; else multiCount++;
            }
            const percent = total > 0 ? Math.round((got / total) * 10000) / 100 : 0;
            return { got, total, percent, singleCount, singleGot, multiCount, multiGot };
        }

        function showResult() {
            const r = scoreNow();
            const t = `👤 ${USER.name}｜📘 ${USER.subject}｜分數：${r.got.toFixed(2)} / ${r.total.toFixed(2)}（${r.percent}%）`;
            qs('#scoreText').textContent = t;
            const badges = qs('#resultBadges');
            badges.innerHTML = '';
            const mk = (txt, cls = 'pill') => { const s = document.createElement('span'); s.className = cls; s.textContent = txt; return s; };
            badges.append(
                mk(`單選答對 ${r.singleGot} / ${r.singleCount}`),
                mk(`複選答對 ${r.multiGot} / ${r.multiCount}`)
            );
            qs('#result').style.display = 'block';
            window.scrollTo({ top: qs('#result').offsetTop - 20, behavior: 'smooth' });
        }

        function exportCSV() {
            const rows = [['name', 'subject', 'qid', 'type', 'correct', 'your_answer', 'points', 'earned']];
            for (const q of quizQuestions) {
                const ans = answered.get(q.id) || new Set();
                const correctSet = new Set(q.correct);
                const isCorrect = ans.size === correctSet.size && [...ans].every(x => correctSet.has(x));
                rows.push([
                    USER.name,
                    USER.subject,
                    q.id,
                    q.type,
                    JSON.stringify(q.correct),
                    JSON.stringify([...ans].sort((a, b) => a - b)),
                    q.points,
                    isCorrect ? q.points : 0
                ]);
            }
            const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g, '""')}"`).join(',')).join('');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${USER.subject || 'quiz'}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }

        // ======= 事件綁定 =======
        qs('#btnUseLastName').onclick = () => { const v = load('quiz:name', ''); if (v) { qs('#username').value = v } else { alert('尚無紀錄'); } };
        qs('#btnClearName').onclick = () => { localStorage.removeItem('quiz:name'); alert('已清除名稱紀錄'); };

        qs('#toStep2').onclick = async () => {
            const name = qs('#username').value.trim();
            if (!name) { alert('請先輸入名稱'); return; }
            USER.name = name; save('quiz:name', name);
            qs('#headerUser').textContent = `👤 ${USER.name}`;
            qs('#step1').style.display = 'none';
            qs('#step2').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            await loadManifest();
        };

        qs('#btnLoadServer').onclick = loadFromServer;
        qs('#btnReloadManifest').onclick = loadManifest;

        function afterPoolLoaded() {
            qs('#headerSubject').textContent = `📘 ${USER.subject}`;
            qs('#step2').style.display = 'none';
            qs('#step3').style.display = 'block';
            qs('#submitBar').style.display = 'block';
            buildQuiz();
            qs('#result').style.display = 'none';
            window.scrollTo({ top: qs('#step3').offsetTop - 20, behavior: 'smooth' });
        }

        qs('#btnCheck').onclick = () => {
            const missing = gatherAnswers();
            if (missing.length === 0) {
                qs('#unansweredHint').textContent = '已完成所有題目，可以送出！';
                qs('#unansweredHint').className = 'good';
            } else {
                qs('#unansweredHint').textContent = `尚有 ${missing.length} 題未作答（例如第 ${findQuestionNumber(missing[0].id)} 題）`;
                qs('#unansweredHint').className = 'warn';
                scrollToEl(qs(`[data-qid="${missing[0].id}"]`));
            }
        };

        function findQuestionNumber(qid) {
            const idx = quizQuestions.findIndex(q => q.id === qid);
            return idx >= 0 ? idx + 1 : '?';
        }

        qs('#btnSubmit').onclick = () => {
            const missing = gatherAnswers();
            if (missing.length > 0) {
                alert(`還有 ${missing.length} 題未作答。請完成後再送出。
（第一個未作答：第 ${findQuestionNumber(missing[0].id)} 題）`);
                scrollToEl(qs(`[data-qid="${missing[0].id}"]`));
                return;
            }
            showResult();
        };

        qs('#btnReview').onclick = () => {
            for (const q of quizQuestions) {
                const wrap = qs(`[data-qid="${q.id}"]`);
                const nodes = qsa(`[name="${q.id}"]`, wrap);
                const ans = answered.get(q.id) || new Set();
                nodes.forEach((n, i) => {
                    const label = n.closest('label');
                    label.style.borderColor = '#e5e7eb'; label.style.background = '#fff';
                    if (q.correct.includes(i)) {
                        label.style.borderColor = '#a7f3d0'; label.style.background = '#ecfdf5';
                    }
                    if (n.checked && !q.correct.includes(i)) {
                        label.style.borderColor = '#fecaca'; label.style.background = '#fef2f2';
                    }
                    n.disabled = true;
                });
            }
            alert('已以綠色標示正確選項、紅色標示您勾選的錯誤選項。');
        };

        qs('#btnRetake').onclick = () => { buildQuiz(); qs('#result').style.display = 'none'; qs('#unansweredHint').textContent = ''; window.scrollTo({ top: qs('#step3').offsetTop - 20, behavior: 'smooth' }); };
        qs('#btnExportCSV').onclick = exportCSV;

        qs('#btnReset').onclick = () => { location.reload(); };

        qs('#btnDownloadTemplate').onclick = () => {
            const tmpl = JSON.stringify(getTemplate(), null, 2);
            const blob = new Blob([tmpl], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'quiz_template.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        };

        function getTemplate() {
            return { subject: "請填入測驗項目名稱", questions: [{ id: "S1", type: "single", q: "Which is a fruit?", options: ["Car", "Apple", "Chair", "Desk"], answer: 1 }, { id: "M1", type: "multi", q: "Select colors.", options: ["Red", "Dog", "Blue", "Table"], answer: [0, 2] }] };
        }

        (function init() { const last = load('quiz:name', ''); if (last) { qs('#username').value = last; } })();
    </script>
</body>
</html>
